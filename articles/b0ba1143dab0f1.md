---
title: "Segformerã‚’ä½¿ã£ã¦è»Šã®Semantic Segmentationã‚’å®Ÿæ–½"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: 
 - "torchlightning"
 - "CUDA"
 - "Docker"
 - "Transformer"
 - "Semantic Segmentation"
published: true
published_at: "2024-06-09 12:25"
---

# ã¯ã˜ã‚ã«
Semantic Segmentationã®ã‚¿ã‚¹ã‚¯ã«Transformerã‚’ä½¿ç”¨ã—ãŸå ´åˆã®æ€§èƒ½ã‚’è©¦ã—ã¦ã¿ãŸã‹ã£ãŸãŸã‚ã€`Segformer`ã‚’ä½¿ç”¨ã—ã¦ã¿ã¾ã—ãŸã€‚

ãªãŠæœ¬ãƒªãƒã‚¸ãƒˆãƒªã¯Kaggleã®[carvana-image-masking-challenge](https://www.kaggle.com/c/carvana-image-masking-challenge)ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å­¦ç¿’ã•ã›ãŸéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ä½œæˆã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ˆã‹ã£ãŸã‚‰è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
https://github.com/ihpolyphe/Segformer

# å‚ç…§
- [å…¬å¼ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/NVlabs/SegFormer)
- [How To Train SegFormer on a Custom Dataset](https://blog.roboflow.com/how-to-train-segformer-on-a-custom-dataset-with-pytorch-lightning/)
- [CUDA10.2ã®Docker Imageã‚’ä½œæˆ](https://qiita.com/dandelion1124/items/31a3452b05510097daa0)

# ç’°å¢ƒæ§‹ç¯‰
[Segformer](https://github.com/ihpolyphe/Segformer)ã¯Dockerç’°å¢ƒã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ç†ç”±ã¯æ—¢å­˜ã®ç’°å¢ƒã‚’å£Šã—ãŸããªã‹ã£ãŸãŸã‚ã€‚ã¾ãŸã€ã‚‚ã¨ã‚‚ã¨CUDA10.2ãŒå…¥ã£ã¦ã„ãŸãŸã‚ã€CUDA10.2ä¸Šã§ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### CUDA10.2ã®Dockerã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
ã¾ãšã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹`nvidia/cuda:10.2-cudnn7-devel-ubuntu18.04`ã‚’å¼•ã£å¼µã£ã¦ãã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ãŒã€24å¹´1æœˆæ™‚ç‚¹ã§EOLã¨ãªã£ãŸCUDAãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãŸãŸã‚ã€å¼•ã£å¼µã£ã¦ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[CUDA10.2ã®Docker Imageã‚’ä½œæˆ](https://qiita.com/dandelion1124/items/31a3452b05510097daa0)ã‚’å‚è€ƒã«ã—ã¦Docker Imageã‚’ä½œæˆã™ã‚‹ã€‚

### å®Ÿè¡Œç’°å¢ƒ
- WSL2ä¸Šã®Dockerã§å®Ÿè¡Œ
- CUDA:10.2
- cudnn:7
- pytorch-lightning: 1.5.10
- torch:1.10.1
- tensorflow:2.6.2
-Nvidia driver:xxx

### å­¦ç¿’ç”¨Docker Imageã‚’ä½œæˆ
`CUDA10.2`ã®Docker Imageã‚’ä½œæˆã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å­¦ç¿’ç”¨ã®Docker Imgageã‚’ä½œæˆã™ã‚‹ã€‚
```
cd Segformer
docker build -t segformer_tensorboard:latest .
```
### Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆå‡ºæ¥ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚Tensorboardã§çµæœã‚’ç¢ºèªã—ãŸã‚Šã™ã‚‹ãŸã‚ã®å¼•æ•°ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚
```
sudo docker run --gpus all --shm-size 32G -it --rm -p 10000:8888 -p 6006:6006 -u 0 --name segformer_tensorboard segformer_tensorboard:latest
```

### å­¦ç¿’
ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•å‡ºæ¥ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å­¦ç¿’ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
```
python3 segformer.py
```
å­¦ç¿’æ™‚ã®lossé…ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å¯è¦–åŒ–ã§ãã¾ã™ã€‚
```
tensorboard --logdir="./lightning_logs/" --bind_all
http://localhost:6006
```

### æ¨è«–
æ¨è«–ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚
```
python3 segformer_inference.py
```
## æ¤œå‡ºçµæœ
ä»¥ä¸‹ã®ã‚ˆã†ã«ã„ã„æ„Ÿã˜ã«æ¨è«–ã§ãã¦ã„ãã†ã§ã™ã€‚
![](/images/predicted_473.png)

```
DATALOADER:0 TEST RESULTS
{'test_loss': 0.06342098116874695,
'test_mean_accuracy': 0.9768195033576641,
'test_mean_iou': 0.9511022762808763}
```
